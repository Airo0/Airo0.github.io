	<!DOCTYPE html>
	<html>
		<head>
			<meta charset="UTF-8">
			<title>VDO.Ninja 参数生成器</title>
			<link rel="icon" href="../favicon.ico">
			<style type="text/css">
			.settings {
				font-family: sans-serif;
				line-height: 30px;
				text-align: center;
				color: #505050;
				background-color: #fff;
				border-radius: 20px;
				width: 430px;
				height: 720px;
				margin: auto;
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				-moz-box-shadow:0 4px 10px rgba(0, 0, 0, 0.4); 
				-webkit-box-shadow:0 4px 10px rgba(0, 0, 0, 0.4); 
				box-shadow:0 4px 10px rgba(0, 0, 0, 0.4); 
			}
			input{
				color: #505050;
				outline-style: none ;
				border: 1px solid #ccc; 
				border-radius: 3px;
				padding: 2px 0px;
				font-size: 14px;
				font-weight: 700;
				text-align: center;
			}
			button{
				border-width: 0px;
				border-radius: 3px;
				background: #1E90FF;
				cursor: pointer;
				outline: none;
				font-family: sans-serif;
				color: white;
				font-size: 13px;
				font-weight:bold;
			}
			</style>
		</head>
		<body style="background-color:#def3fd">
			<div class="settings" id="main">
			<br>
				<b style="font-size: 18px;">VDO.Ninja <img src="https://guides.vdo.ninja/assets/images/logo.png" alt="Ninja" style="width: 14px;"/> 参数生成器 (By: <a href="https://space.bilibili.com/1655906003">艾洛Airo<a>)</b>
			<HR>
				<video autoplay="true" muted="true" id="player" style="height: 180px;" controls></video>
				<div>
					默认摄像头:
					<select id="videoSource" onchange="generateURL()" style="width:260px"></select>
				<div id="audioSelector" style="display: none">
					默认麦克风:
					<select id="audioSource" onchange="generateURL()" style="width:260px"></select>
				</div>
				<button type="button" id="reget" style="width: 350px;" onclick="getDevice()" >更新设备列表</button>
				<HR>
					串流码率 (10~60000Kbps):
					<input type="number" id="vb" value="3000" oninput="if(value>60000)value=60000;if(value<10)value=10" onchange="generateURL()" />
				<br>
				<div>
					画面分辨率:
					<select id="quality" onchange="generateURL()">
					　　<option value="0">1080P</option>
					　　<option value="1">720P(省电)</option>
					　　<option value="2">360P</option>
					</select>
					串流编码器:
					<select id="codec" onchange="generateURL()">
						<option value="vp9">VP9(推荐)</option>
						<option value="h264">H264</option>
					　　 <option value="vp8">VP8</option>
						<option value="av1">AV1(不推荐)</option>
					</select>
				</div>
					自动开播:<input type="CheckBox" id="autostart" value="1" checked ='checked' onchange="generateURL()"/>
					镜像画面:<input type="CheckBox" id="mirror" value="1" onchange="generateURL()"/>
					启用音频:<input type="CheckBox" id="audio" value="1" onchange="switchAudio();generateURL()"/>
					屏幕分享:<input type="CheckBox" id="screen" value="1" onchange="generateURL()"/>
				</div>
				<HR>
					房间ID (仅字母):
					<input type="text" id="room" onkeyup="this.value=this.value.replace(/[^a-zA-Z]/g,'');generateURL()" onchange="if(this.value==''){randomRoomID();generateURL()}" />
					<button type="button" id="random" onclick="randomRoomID();generateURL()">重新生成</button>
				<br>
					房间密码 (可选):
					<input type="text" id="password" onkeyup="generateURL()" />
					<button type="button" id="random2" onclick="document.getElementById('password').value='';generateURL()">不设密码</button>
				<HR>
				<div>
					串流链接: 
					<input type="text" id="server" style="width:300px" readonly="true">
				<br>
					分享链接: 
					<input type="text" id="client" style="width:300px" readonly="true">
				<HR>
					<button type="button" id="goto" onclick="start()" style="width:350px">开始串流<br>(链接可复制保留重复使用)</button>
				</div>
			</div>
			<script>
				var isFirefox =  navigator.userAgent.indexOf('Firefox') > -1
				var isChrome =  navigator.userAgent.indexOf('Chrome') > -1
				var isEdge =  navigator.userAgent.indexOf('Edg') > -1
				var isSafari =  navigator.userAgent.indexOf('Safari') > -1
				if (isFirefox || isChrome || isEdge || isSafari){
					if (!isChrome && isSafari){
						alert("您正在使用Safari浏览器, 可能无法获取虚拟摄像头/麦克风.\n请考虑换用Chrome或Firefox内核的浏览器来进行串流!");
					}
				}else{
					document.getElementById("main").innerHTML = "<br>请使用Chrome或Firefox内核的浏览器访问此页面!";
				}
				function start() {
					var Url2 = document.getElementById('client');
					Url2.select();
					document.execCommand('Copy');
					if (document.getElementById("autostart").checked){
						alert('点击 [确定] 并授予摄像头权限以串流, 推流时请勿关闭浏览器.\n分享链接已经复制到您的剪贴板, 请发给对方即可.');
					}else{
						alert('点击 [确定] 并选择您要推流的是摄像头还是屏幕.\n请允许网站访问摄像头以进行串流, 推流时不要关闭浏览器.\n分享链接已经复制到您的剪贴板, 请发给对方即可.');
					}
					location = document.getElementById('server').value;
				}
				function getSelectText(id) {
					var obj = document.getElementById(id)
					var index = obj.selectedIndex;
					return obj.options[index].text;
				}
				function getSelectValue(id) {
					var obj = document.getElementById(id)
					var index = obj.selectedIndex;
					return obj.options[index].value;
				}
				function getSelectCheck(id,v1,v2) {
					var state = document.getElementById(id)
					if (state.checked) {
						return v1;
					}else{
						return v2;
					}
				}
				function switchAudio() {
					var audioSelector = document.getElementById("audioSelector");
					var audio = document.getElementById("audio")
					if (audio.checked) {
						audioSelector.style = "display: block"
					}else{
						audioSelector.style = "display: none"
					}
				}
				function generateURL() {
					var password = document.getElementById("password").value
					if (password != "") {
						password = "&p=" + password
					}
					
					var screens = getSelectCheck("screen","","&wc")
					if (screens == ""){
						document.getElementById("autostart").checked = 0;
					}else{
						document.getElementById("autostart").checked = 1;
					}
					
					var audioLabel = getSelectCheck("audio","","&ad=0")
					if (audioLabel == "") {
						audioLabel = "&ad=" + encodeURIComponent(getSelectText("audioSource"))
					}
					
					var cameraLabel = "&vd=" + encodeURIComponent(getSelectText("videoSource"));
					var server = document.getElementById("server");
					var client = document.getElementById("client");
					var vb = "&vb=" + document.getElementById("vb").value;
					var roomID = document.getElementById("room").value;
					var quality = "&q=" + getSelectValue("quality");
					var codec = "&codec=" + getSelectValue("codec");
					var autostart = getSelectCheck("autostart","&as","")
					var mirror = getSelectCheck("mirror","&mirror","")
					
					var serverUrl = "https://vdo.ninja/?ln=cn&push=" + roomID + cameraLabel + audioLabel + quality + mirror + screens + autostart + password
					var clientUrl = "https://vdo.ninja/?cv&view=" + roomID + codec + vb + password
					server.value = serverUrl
					client.value = clientUrl
				}
				function random(char) {
				 　　len = 16 || 32;
				 　　var $chars = char;
				　 　var maxPos = $chars.length;
				　 　var pwd = '';
				　 　for (i = 0; i < len; i++) {
				　　 　　pwd += $chars.charAt(Math.floor(Math.random() * maxPos));
				　　 }
					return pwd;
				}
				function randomRoomID() {
					var room = document.getElementById('room');
					room.value = random('ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz');
					room = null;
				}
				function randomPwd() {
					var pwd = document.getElementById('password');
					pwd.value = random('ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890');
					pwd = null;
				}
				randomRoomID()
				randomPwd()
			</script>
			<script>
				function getDevice() {
					let videoSourcesSelect = document.getElementById("videoSource");
					let audioSourcesSelect = document.getElementById("audioSource");
					videoSourcesSelect.innerHTML = "";
					audioSourcesSelect.innerHTML = "";
					let videoPlayer = document.getElementById("player");

					videoSourcesSelect.onchange = function(){
						MediaStreamHelper.requestStream().then(function(stream){
							MediaStreamHelper._stream = stream;
							videoPlayer.srcObject = stream;
						});
						if (getSelectText("videoSource") == "VTubeStudioCam"){
							document.getElementById("mirror").checked = 1;
						}else{
							document.getElementById("mirror").checked = 0;
						}
						generateURL();
					};

					audioSourcesSelect.onchange = function(){
						MediaStreamHelper.requestStream().then(function(stream){
							MediaStreamHelper._stream = stream;
							videoPlayer.srcObject = stream;
						});
						generateURL();
					};

					// Create Helper to ask for permission and list devices
					let MediaStreamHelper = {
						// Property of the object to store the current stream
						_stream: null,
						// This method will return the promise to list the real devices
						getDevices: function() {
							return navigator.mediaDevices.enumerateDevices();
						},
						// Request user permissions to access the camera and video
						requestStream: function() {
							if (this._stream) {
								this._stream.getTracks().forEach(track => {
									track.stop();
								});
							}

							const audioSource = audioSourcesSelect.value;
							const videoSource = videoSourcesSelect.value;
							const constraints = {
								audio: {
									deviceId: audioSource ? {exact: audioSource} : undefined
								},
								video: {
									deviceId: videoSource ? {exact: videoSource} : undefined
								}
							};
						
							return navigator.mediaDevices.getUserMedia(constraints);
						}
					};
					
					// Request streams (audio and video), ask for permission and display streams in the video element
					MediaStreamHelper.requestStream().then(function(stream){
						console.log(stream);
						// Store Current Stream
						MediaStreamHelper._stream = stream;

						// Select the Current Streams in the list of devices
						audioSourcesSelect.selectedIndex = [...audioSourcesSelect.options].findIndex(option => option.text === stream.getAudioTracks()[0].label);
						videoSourcesSelect.selectedIndex = [...videoSourcesSelect.options].findIndex(option => option.text === stream.getVideoTracks()[0].label);

						// Play the current stream in the Video element
						videoPlayer.srcObject = stream;
						
						// You can now list the devices using the Helper
						MediaStreamHelper.getDevices().then((devices) => {
							// Iterate over all the list of devices (InputDeviceInfo and MediaDeviceInfo)
							devices.forEach((device) => {
								let option = new Option();
								option.value = device.deviceId;

								// According to the type of media device
								switch(device.kind){
									// Append device to list of Cameras
									case "videoinput":
										option.text = device.label || `Camera ${videoSourcesSelect.length + 1}`;
										videoSourcesSelect.appendChild(option);
										break;
									// Append device to list of Microphone
									case "audioinput":
										option.text = device.label || `Microphone ${videoSourcesSelect.length + 1}`;
										audioSourcesSelect.appendChild(option);
										break;
								}
								console.log(device);
								
							});
							generateURL();
						}).catch(function (e) {
							console.log(e.name + ": " + e.message);
						});
					}).catch(function(err){
						console.error(err);
					});
				}
				getDevice()
			</script>
		</body>
	</html>
